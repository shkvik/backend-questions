# backend-questions

### 1. Как предотвратить одноврменную запись в базу данных, если существует несколько приложений, которые хотят взаимодействовать с данными?
#### Задача
Есть сервис по подпискам, который списывает деньги у пользователей. Необходимо списывать деньги ежимесячно. 3 реплики Cron будут одновременно опрашивать БД с определенным интервалом. Как предотвратить повторные списывания средств, то есть предотовратить одноврменный доступ к БД?

#### Решение

*Какими подходами можно пользоваться*

**1. Блокировка строк:**
```sql
BEGIN;

-- Блокируем строку пользователя с id = 123 для изменений
SELECT * FROM users WHERE id = 123 FOR UPDATE;

-- Выполняем операции, которые требуют блокировки, например, списание средств

COMMIT;

```
**FOR UPDATE**

Ключевое слово **FOR UPDATE** используется в SELECT-запросе и служит для блокировки выбранных строк до завершения текущей транзакции. Это предотвращает другие транзакции от изменения этих строк до тех пор, пока текущая транзакция не завершится. Основные аспекты FOR UPDATE:
1. **Блокировка строк:** FOR UPDATE блокирует строки, удовлетворяющие условиям SELECT-запроса. Другие транзакции, пытающиеся изменить заблокированные строки, будут ожидать их разблокировки.
2. **Защита от конфликтов:** Это помогает предотвратить конфликты при одновременном доступе к данным, такие как двойное списание средств или другие сценарии, где несколько транзакций пытаются изменить одни и те же данные.

⚠ ***Различия между уровнями изоляции и FOR UPDATE:***

**Цель**
1. Уровни изоляции определяют уровень защиты данных в пределах транзакции от конкурентного доступа и модификации.
2. FOR UPDATE используется для явного управления блокировками строк в пределах текущей транзакции.

**Область применения**
1. Уровни изоляции применяются ко всему транзакционному контексту и определяют, какие аномалии изоляции данных могут происходить.
2. FOR UPDATE применяется к конкретным SELECT-запросам для предотвращения конфликтов при параллельном доступе к данным.

**Видимость данных**
1. Уровни изоляции контролируют, какие данные транзакция может видеть в зависимости от состояния других транзакций.
2. FOR UPDATE контролирует доступ к изменению данных в пределах текущей транзакции.

**Эффекты на производительность**
1. Уровни изоляции могут влиять на производительность, потому что более строгие уровни могут привести к большему количеству блокировок и ожиданий.
2. Использование FOR UPDATE может помочь управлять блокировками более точечно и предотвращать необходимость в более строгих уровнях изоляции.
![Ringfence Programm - Frame 4](https://github.com/shkvik/backend-questions/assets/75574213/214f0694-3581-435a-91a8-8658c2e4cd27)

**2. Уровни изоляций транзакций**

